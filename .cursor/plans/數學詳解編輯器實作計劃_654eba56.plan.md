---
name: 數學詳解編輯器實作計劃
overview: 實作基於 Tiptap + MathLive 的數學詳解編輯器，整合 2D/3D 繪圖功能，並在 Tiptap 中整合 CodeMirror 6 用於 LaTeX 公式編輯。後端提供 JSON 轉 LaTeX 和 Markdown 匯出功能。
todos:
  - id: backend_model
    content: 修改 QuestionBank 模型，新增 solution_content JSONField 和 search_text_content TextField 欄位
    status: completed
  - id: backend_serializer
    content: 更新 QuestionBankSerializer，支援 solution_content 欄位
    status: completed
  - id: backend_migration
    content: 創建 Django migration 檔案（包含 solution_content 和 search_text_content）
    status: completed
  - id: backend_search_hook
    content: 在 QuestionBank.save() 中實作自動提取 search_text_content 的邏輯
    status: completed
  - id: frontend_dependencies
    content: 安裝前端依賴：Tiptap、MathLive、JSXGraph、TresJS、CodeMirror 語言包、SVG.js/LogicFlow
    status: completed
  - id: image_upload_extension
    content: 創建 ImageUpload.js 擴展（Critical：處理圖片上傳，防止 Base64）
    status: pending
  - id: tiptap_editor
    content: 創建 RichTextEditor.vue 主編輯器組件（整合所有擴展）
    status: completed
  - id: mathlive_extension
    content: 創建 MathFieldExtension.js（MathLive 整合，用於行內公式）
    status: completed
  - id: codeblock_extension
    content: 創建 CodeBlockExtension.js 和 CodeBlockComponent.vue（CodeMirror 6 整合）
    status: completed
  - id: latex_formula_node
    content: 創建 LaTeX 公式節點（LatexFormulaExtension.js 和 LatexFormulaNode.vue，用於區塊公式）
    status: completed
  - id: math2d_plotter
    content: 創建 Math2DPlotter.vue 組件（JSXGraph，包含 backup_image 生成）
    status: completed
  - id: circuit_editor
    content: 創建 CircuitEditor.vue 組件（電路圖編輯，使用 SVG.js 或 LogicFlow）
    status: pending
  - id: math3d_viewer
    content: 創建 Math3DViewer.vue 組件（TresJS，包含 backup_image 生成，動態引入）
    status: completed
  - id: diagram_converter
    content: 創建後端 DiagramConverter 工具類（JSON → LaTeX，包含 try-except fallback 機制）
    status: completed
  - id: markdown_exporter
    content: 創建後端 MarkdownExporter 工具類（Tiptap JSON → Markdown）
    status: completed
  - id: api_endpoints
    content: 新增 API 端點：export_to_latex 和 export_to_markdown
    status: completed
  - id: question_form_update
    content: 更新 QuestionForm.vue，整合 RichTextEditor
    status: completed
  - id: api_service_update
    content: 更新前端 API 服務，支援 solution_content
    status: completed
  - id: performance_optimization
    content: 實作動態引入（lazy loading）優化前端效能
    status: pending
---

# 數學詳解編輯器實作計劃

## 一、架構檢查與修改需求

### 1.1 後端模型修改

**QuestionBank 模型擴展** (`backend/cramschool/models.py`):

- 現有 `correct_answer` 欄位為 `TextField`，存儲 Markdown + LaTeX
- **修改方案**: 新增 `solution_content` JSONField 欄位，用於存儲 Tiptap JSON 格式的詳解
- 保留 `correct_answer` 作為簡短答案（向後兼容）
- 新增 `solution_content` 作為完整詳解（支援富文本、2D/3D 圖形）
- **新增 `search_text_content`**: 用於全文檢索的純文字欄位（從 Tiptap JSON 提取）
```python
# 需要新增的欄位
solution_content = models.JSONField(
    default=dict,
    blank=True,
    null=True,
    verbose_name='詳解內容 (Tiptap JSON)'
)

search_text_content = models.TextField(
    blank=True,
    null=True,
    help_text='用於全文檢索的純文字（從 Tiptap JSON 自動提取）',
    verbose_name='搜尋文字內容'
)
```

**重要**: 在 `QuestionBank.save()` 方法中加入 hook，自動從 `solution_content` JSON 中提取純文字節點，存入 `search_text_content`。


### 1.2 序列化器修改

**QuestionBankSerializer** (`backend/cramschool/serializers.py`):

- 新增 `solution_content` 欄位到 `fields`
- 確保 JSONField 正確序列化/反序列化

### 1.3 前端依賴安裝

需要新增的 npm 套件 (`frontend/package.json`):

```json
{
  "@tiptap/vue-3": "^2.x",
  "@tiptap/starter-kit": "^2.x",
  "@tiptap/extension-code-block": "^2.x",
  "mathlive": "^0.95.x",
  "jsxgraph": "^1.7.x",
  "@tresjs/core": "^1.x",
  "@codemirror/lang-python": "^6.x",
  "@codemirror/lang-json": "^6.x",
  "@codemirror/lang-cpp": "^6.x",
  "@codemirror/theme-one-dark": "^6.x"
}
```

### 1.4 前端組件結構

需要創建的新組件：

- `frontend/src/components/RichTextEditor.vue` - Tiptap 主編輯器
- `frontend/src/extensions/ImageUpload.js` - **圖片上傳擴展（Critical）**
- `frontend/src/components/MathFieldExtension.js` - MathLive 自定義擴展（行內公式）
- `frontend/src/components/Math2DPlotter.vue` - 2D 繪圖組件
- `frontend/src/components/CircuitEditor.vue` - **電路圖編輯組件（Phase 2.5）**
- `frontend/src/components/Math3DViewer.vue` - 3D 視覺化組件
- `frontend/src/components/CodeBlockComponent.vue` - CodeMirror 6 整合組件
- `frontend/src/components/CodeBlockExtension.js` - CodeMirror 6 擴展
- `frontend/src/components/LatexFormulaNode.vue` - LaTeX 公式節點組件（區塊公式）
- `frontend/src/components/LatexFormulaExtension.js` - LaTeX 公式擴展

## 二、Phase 1: 基礎建設與詳解編輯器

### 2.1 Tiptap 編輯器組件

**文件**: `frontend/src/components/RichTextEditor.vue`

- 使用 Tiptap Vue 3 整合
- 整合 StarterKit（段落、標題、列表、粗體、斜體等）
- 整合 CodeBlock 擴展（使用 CodeMirror 6）
- 整合 MathLive 擴展（數學公式輸入）
- 整合 LaTeX 公式節點（顯示/編輯模式切換）

### 2.2 MathLive 自定義擴展（行內公式）

**文件**: `frontend/src/components/MathFieldExtension.js`

- 創建 Tiptap Node 擴展（標記為 `inline: true`）
- 使用 `<math-field>` 作為編輯器
- 保存 LaTeX 字串到節點屬性
- 渲染時使用 KaTeX 顯示
- **用途**: 用於文字流中的行內公式（如 $E=mc^2$）

### 2.3 圖片上傳處理機制（Critical）

**文件**: `frontend/src/extensions/ImageUpload.js`

- 自定義 Tiptap Image Extension
- **攔截 paste 事件**: 當用戶貼上圖片時，阻止預設的 Base64 轉換
- **攔截 drop 事件**: 當用戶拖放圖片時，自動上傳
- **上傳流程**:
  1. 攔截圖片（File 對象）
  2. 呼叫後端 `POST /api/upload_image/` API
  3. 獲取返回的圖片 URL
  4. 插入 Tiptap Image 節點（使用 URL，而非 Base64）
- **後端 API**: 使用現有的 `upload_image` 端點（`backend/cramschool/api_views.py`）

**重要**: 防止 Base64 圖片直接存入 JSON，避免資料庫爆炸。

### 2.4 CodeMirror 與 MathLive 的分工

**明確分工策略**:

- **MathLive (MathFieldExtension)**: 
  - 用於 **行內公式**（Inline Math）
  - 例如：$E=mc^2$、$x = \frac{-b \pm \sqrt{b^2-4ac}}{2a}$
  - GUI 體驗最佳，適合快速輸入

- **CodeMirror 6 (LatexFormulaExtension)**:
  - 用於 **區塊公式**（Block Math）
  - 例如：多行對齊、矩陣、複雜推導
  - 手寫 LaTeX 源碼，適合複雜公式
  - 使用 `$$\begin{align}...\end{align}$$` 格式

**數據結構**: Tiptap 節點需區分 `inline` 和 `block` 屬性，確保正確渲染。

## 三、Phase 2: 2D 數學繪圖引擎

### 3.1 Math2DPlotter 組件

**文件**: `frontend/src/components/Math2DPlotter.vue`

- 使用 JSXGraph 繪製 2D 圖形
- 支援函數圖形、多邊形、點、線
- 側邊欄 UI 用於添加元素
- 輸出 JSON 格式描述圖形結構
- **備援機制**: 同時生成 SVG 字串或 Base64 PNG，存入 `backup_image` 欄位

### 3.2 Tiptap 2D 圖形節點

**文件**: `frontend/src/components/Diagram2DExtension.js`

- 創建 Tiptap Node 擴展
- 嵌入 Math2DPlotter 組件
- 保存 JSON 數據到節點屬性
- **保存結構**: `{ diagram_data: {...}, backup_image: "data:image/svg+xml;base64,..." }`

### 3.3 電路圖編輯組件（Phase 2.5）

**文件**: `frontend/src/components/CircuitEditor.vue`

- 使用 **SVG.js** 或 **LogicFlow** 繪製電路圖
- 專注於電路元件庫：電阻、電容、電感、電源、開關等
- 支援拖拉與連線功能
- 輸出 JSON 格式描述電路結構
- **備援機制**: 同時生成 SVG 字串，存入 `backup_image`

**文件**: `frontend/src/components/CircuitExtension.js`

- 創建 Tiptap Node 擴展
- 嵌入 CircuitEditor 組件
- 保存電路 JSON 數據

## 四、Phase 3: 3D 數學瀏覽器

### 4.1 Math3DViewer 組件

**文件**: `frontend/src/components/Math3DViewer.vue`

- 使用 TresJS（Vue Three.js 包裝）渲染 3D 場景
- 支援向量、立方體、球體等
- OrbitControls 用於旋轉/縮放
- `exportToImage()` 函數導出 Base64 PNG
- **備援機制**: 自動將當前 Canvas 狀態導出為 Base64 PNG，存入 `backup_image`

### 4.2 Tiptap 3D 圖形節點

**文件**: `frontend/src/components/Diagram3DExtension.js`

- 創建 Tiptap Node 擴展
- 嵌入 Math3DViewer 組件
- 保存 JSON 數據和 Base64 圖片（`backup_image`）

## 五、Phase 4: CodeMirror 6 整合（新增需求）

### 5.1 CodeBlock 擴展

**文件**: `frontend/src/components/CodeBlockExtension.js`

- 擴展 Tiptap 的 CodeBlock
- 使用 Vue NodeView
- 整合 CodeMirror 6 實例

### 5.2 CodeBlock 組件

**文件**: `frontend/src/components/CodeBlockComponent.vue`

- 初始化 CodeMirror 6
- 雙向綁定（CodeMirror ↔ Tiptap）
- 語言選擇器（Python, C++, LaTeX, JSON）
- One Dark 主題
- 防止鍵盤快捷鍵衝突（stopEvent）

### 5.3 LaTeX 公式節點（進階）

**文件**: `frontend/src/components/LatexFormulaNode.vue`

- 顯示模式：使用 KaTeX 渲染公式
- 編輯模式：點擊後切換為 CodeMirror 6 編輯器
- LaTeX 語法高亮
- 自動預覽更新

**文件**: `frontend/src/components/LatexFormulaExtension.js`

- 創建 Tiptap Node 擴展
- 定義節點屬性（LaTeX 字串）
- 使用 Vue NodeView

## 六、Phase 5: 後端轉換核心

### 6.1 DiagramConverter 工具類

**文件**: `backend/cramschool/utils/diagram_converter.py`

- `json_to_tikz_2d(data)`: 2D JSON → TikZ/PGFPlots LaTeX
- `json_to_circuitikz(data)`: 電路圖 JSON → Circuitikz LaTeX
- `json_to_latex_3d(data)`: 3D JSON → TikZ-3Dplot 或 `\includegraphics`

**保險機制（Fallback Strategy）**:

所有轉換函數都使用 `try-except` 包裹：

```python
def json_to_tikz_2d(data):
    try:
        # 嘗試轉換 JSON 為 TikZ
        tikz_code = convert_json_to_tikz(data['diagram_data'])
        return tikz_code
    except Exception as e:
        # 轉換失敗，使用備援圖片
        if 'backup_image' in data:
            # 保存 Base64 圖片到臨時文件
            image_path = save_base64_image(data['backup_image'])
            return f'\\includegraphics{{{image_path}}}'
        else:
            raise ValueError(f"轉換失敗且無備援圖片: {e}")
```

**前端責任**: 在保存 Tiptap 節點時，必須同時提供 `backup_image` 欄位。

### 6.2 Markdown 匯出功能

**文件**: `backend/cramschool/utils/markdown_exporter.py`

- `solution_to_markdown(tiptap_json)`: Tiptap JSON → Markdown
- 處理文本節點 → Markdown
- 處理 MathLive 節點 → `$...$` 或 `$$...$$`
- 處理圖形節點 → SVG 或 HTML 標籤

### 6.3 API 端點

**文件**: `backend/cramschool/api_views.py`

- 新增 `export_to_latex` action（導出 LaTeX）
- 新增 `export_to_markdown` action（導出 Markdown）

## 七、前端整合

### 7.1 修改 QuestionForm.vue

**文件**: `frontend/src/views/QuestionForm.vue`

- 替換 `correct_answer` 的 MarkdownEditor 為 RichTextEditor
- 新增 `solution_content` 欄位（如果使用獨立欄位）
- 整合 2D/3D 繪圖按鈕到工具列

### 7.2 API 服務更新

**文件**: `frontend/src/services/api.js`

- 更新 `questionBankAPI` 以支援 `solution_content` 欄位

### 7.3 前端效能優化（動態引入）

**文件**: `frontend/src/components/RichTextEditor.vue`

- **懶加載策略**: 使用 Vue 3 的 `defineAsyncComponent` 或動態 `import()`
- **組件載入時機**:
  - MathLive: 立即載入（行內公式常用）
  - CodeMirror 6: 立即載入（代碼塊常用）
  - JSXGraph (2D): 點擊「插入 2D 圖形」時才載入
  - TresJS (3D): 點擊「插入 3D 圖形」時才載入
  - CircuitEditor: 點擊「插入電路圖」時才載入

**範例**:
```javascript
const Math3DViewer = defineAsyncComponent(() => 
  import('./Math3DViewer.vue')
)
```

**Tiptap NodeView 支援**: 使用 `AsyncComponent` 作為 NodeView，確保大型組件按需載入。

## 八、資料遷移

### 8.1 Django Migration

**文件**: `backend/cramschool/migrations/XXXX_add_solution_content.py`

- 新增 `solution_content` JSONField
- 新增 `search_text_content` TextField（用於全文檢索）
- 可選：將現有 `correct_answer` 轉換為初始 JSON 格式

### 8.2 搜尋功能優化

**文件**: `backend/cramschool/models.py` (QuestionBank.save 方法)

- 在保存時自動提取 `solution_content` JSON 中的純文字節點
- 存入 `search_text_content` 欄位
- 搜尋時使用 `search_text_content__icontains` 而非直接搜尋 JSON

**提取邏輯**:
```python
def extract_text_from_tiptap_json(json_data):
    """遞迴提取 Tiptap JSON 中的所有文字節點"""
    text_parts = []
    # 遍歷 JSON 節點，提取 type='text' 的節點內容
    return ' '.join(text_parts)
```

## 九、技術要點

### 9.1 Tiptap NodeView 最佳實踐

- 使用 Vue 3 Composition API
- 正確處理節點更新和銷毀
- 防止事件冒泡衝突

### 9.2 CodeMirror 6 整合

- 使用 `stopEvent` 防止 Tiptap 鍵盤快捷鍵觸發
- 正確處理語言切換
- 主題切換（One Dark）

### 9.3 LaTeX 公式節點

- 雙向綁定：CodeMirror 內容 ↔ Tiptap 節點屬性
- 點擊切換顯示/編輯模式
- KaTeX 渲染優化

## 十、測試建議

1. **前端測試**:

   - Tiptap 編輯器基本功能
   - MathLive 公式輸入
   - CodeMirror 6 代碼塊編輯
   - LaTeX 公式節點切換
   - 2D/3D 圖形創建和保存

2. **後端測試**:

   - JSON 轉 LaTeX 轉換
   - Markdown 匯出
   - API 端點響應

## 十一、實施順序建議

1. **第一階段**: Phase 1 + CodeMirror 6 整合（基礎編輯器）
2. **第二階段**: Phase 2（2D 繪圖）
3. **第三階段**: Phase 3（3D 視覺化）
4. **第四階段**: Phase 4（後端轉換）
5. **第五階段**: Phase 5（Markdown 匯出）

## 十二、注意事項

1. **向後兼容**: 保留 `correct_answer` 欄位，確保現有資料可用
2. **性能優化**: 
   - 大型 JSON 內容的載入和渲染
   - 使用動態引入避免一次性載入所有重型組件
   - MathLive (~600KB)、JSXGraph (~300KB)、TresJS (~600KB+) 按需載入
3. **錯誤處理**: 
   - 無效 JSON 或轉換失敗的處理
   - **保險機制**: 所有圖形節點必須包含 `backup_image`，確保 LaTeX 轉換失敗時仍可印刷
4. **用戶體驗**: 
   - 編輯器切換流暢，預覽即時更新
   - 明確區分 MathLive（行內）和 CodeMirror（區塊）的使用場景
5. **圖片上傳**: 
   - **絕對禁止** Base64 圖片直接存入 JSON
   - 所有圖片必須上傳到後端，使用 URL 引用
6. **全文檢索**: 
   - 使用 `search_text_content` 欄位進行搜尋，而非直接搜尋 JSON
   - 確保保存時自動更新 `search_text_content`

## 十三、補充實作清單

### 補充 A: 圖片上傳處理（Critical）

- [ ] 創建 `ImageUpload.js` 擴展
- [ ] 整合 paste/drop 事件攔截
- [ ] 呼叫後端 `/api/upload_image/` API
- [ ] 測試 Base64 轉 URL 流程

### 補充 B: 資料備援機制

- [ ] 在 Math2DPlotter 中生成 `backup_image` (SVG/PNG)
- [ ] 在 Math3DViewer 中生成 `backup_image` (PNG)
- [ ] 在 CircuitEditor 中生成 `backup_image` (SVG)
- [ ] 後端 DiagramConverter 實作 try-except fallback

### 補充 C: 電路圖組件（Phase 2.5）

- [ ] 創建 `CircuitEditor.vue`（使用 SVG.js 或 LogicFlow）
- [ ] 創建 `CircuitExtension.js` Tiptap 擴展
- [ ] 實作電路元件庫（電阻、電容、電源等）
- [ ] 後端 `json_to_circuitikz` 轉換函數

### 補充 D: 搜尋與索引

- [ ] 在 QuestionBank.save() 中實作文字提取邏輯
- [ ] 更新搜尋 API 使用 `search_text_content__icontains`
- [ ] 測試全文檢索功能

### 補充 E: 前端效能優化

- [ ] 實作 Math3DViewer 動態引入
- [ ] 實作 CircuitEditor 動態引入
- [ ] 測試懶加載效能