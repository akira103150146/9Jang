---
name: 多紙張容器分頁架構
overview: 重構 ResourceEditor 和 BlockEditor，將單一連續編輯器改為多個獨立紙張容器，每個容器有固定高度和獨立的 BlockEditor 實例，實現真正的視覺分頁效果。
todos: []
---

# 多紙張容器分頁架構實現計劃

## 目標

將當前的單一連續編輯器改為多個獨立紙張容器，實現：

- 視覺上完全分離的紙張（像 Google Docs / Word）
- 每張紙固定高度（A4: 297mm, B4: 353mm）
- 紙張之間有明顯間隔
- 列印時頁碼正確顯示
- 防止節點被分割（整個節點移到下一頁）

## 架構變更

### 當前架構

```javascript
ResourceEditor
  └── 單一白色容器 (bg-white, padding: 20mm)
      └── BlockEditor (單一 Tiptap 實例)
          └── 連續內容 + PageBreakBlock 節點
```



### 新架構

```javascript
ResourceEditor
  └── 灰色背景容器 (bg-slate-100)
      ├── 紙張 1 (白色容器, 固定高度 297mm)
      │   └── BlockEditor 實例 1 (readonly, 顯示第 1 頁內容)
      ├── 間隔 (灰色, 2rem)
      ├── 紙張 2 (白色容器, 固定高度 297mm)
      │   └── BlockEditor 實例 2 (readonly, 顯示第 2 頁內容)
      └── ...
```



## 核心實現邏輯

### 1. 內容分割算法

在 `ResourceEditor.vue` 中新增 `computed` 屬性 `handoutPages`：

```javascript
const handoutPages = computed(() => {
  if (resource.mode !== 'HANDOUT') return []
  
  const pageHeightPx = paperSize === 'A4' ? 971 : 1183
  const pages = []
  let currentPage = []
  let currentHeight = 0
  
  // 遍歷所有頂層節點
  tiptapStructure.value.content?.forEach((node) => {
    // 如果是分頁符號，強制開始新頁
    if (node.type === 'pageBreak') {
      if (currentPage.length > 0) {
        pages.push([...currentPage])
        currentPage = []
        currentHeight = 0
      }
      return
    }
    
    // 估算節點高度（使用預設值）
    const estimatedHeight = estimateNodeHeight(node)
    
    // 如果加入此節點會超過頁面高度
    if (currentHeight + estimatedHeight > pageHeightPx && currentPage.length > 0) {
      // 完整節點移到下一頁（不分割）
      pages.push([...currentPage])
      currentPage = [node]
      currentHeight = estimatedHeight
    } else {
      currentPage.push(node)
      currentHeight += estimatedHeight
    }
  })
  
  // 加入最後一頁
  if (currentPage.length > 0) {
    pages.push(currentPage)
  }
  
  return pages
})
```



### 2. 節點高度估算

```javascript
function estimateNodeHeight(node) {
  const baseHeights = {
    paragraph: 60,
    heading: { 1: 100, 2: 80, 3: 70 },
    latexBlock: 150,
    image: 200,
    imagePlaceholder: 200,
    bulletList: 80,
    orderedList: 80,
    blockquote: 80,
    codeBlock: 100,
    questionBlock: 300,
    templateBlock: 200,
  }
  
  // 根據節點類型返回估算高度
  if (node.type === 'heading') {
    return baseHeights.heading[node.attrs?.level || 1]
  }
  
  return baseHeights[node.type] || 60
}
```



### 3. 模板重構

在 `ResourceEditor.vue` 中修改講義模式的渲染：

```vue
<!-- 講義模式：多個獨立紙張 -->
<div v-if="resource.mode === 'HANDOUT'" class="flex-1 overflow-auto relative bg-slate-100 p-8">
  <div 
    v-for="(pageContent, pageIndex) in handoutPages" 
    :key="`page-${pageIndex}`"
    class="paper-container mx-auto bg-white shadow-md mb-8 relative"
    :class="paperSize === 'A4' ? 'w-[210mm]' : 'w-[250mm]'"
    :style="{
      height: paperSize === 'A4' ? '297mm' : '353mm',
      padding: '20mm',
      overflow: 'hidden'
    }"
  >
    <!-- 頁碼 -->
    <div class="page-number-display">
      第 {{ pageIndex + 1 }} 頁
    </div>
    
    <!-- 該頁的 BlockEditor（唯讀顯示） -->
    <BlockEditor
      :model-value="{ type: 'doc', content: pageContent }"
      :templates="templates"
      :questions="questions"
      :paper-size="paperSize"
      :image-mappings="imageMappings"
      :readonly="true"
      @request-upload="openImageFolderUpload"
    />
  </div>
</div>
```



### 4. 編輯體驗處理

由於多個 BlockEditor 實例都是 readonly，需要一個**主編輯器**：**選項 A**：保留原有的單一編輯器作為編輯模式，多紙張只用於預覽**選項 B**：實現跨頁編輯（複雜，需要同步多個實例）建議使用**選項 A**：

- 編輯時：使用單一連續編輯器（當前的 BlockEditor）
- 預覽時：切換到多紙張視圖
- 或者在講義模式下提供「編輯模式」和「預覽模式」切換

## 關鍵挑戰

### 1. 節點高度估算不準確

- **問題**：無法在分割前準確知道每個節點的實際渲染高度
- **解決**：使用保守的估算值，寧可多留空間

### 2. LaTeX 和圖片的動態高度

- **問題**：LaTeX 公式和圖片的高度在渲染前無法確定
- **解決**：給這些節點較大的預設高度（200-300px）

### 3. 編輯同步

- **問題**：多個 readonly BlockEditor 實例如何反映編輯變更
- **解決**：編輯時使用單一編輯器，`handoutPages` 作為 computed 屬性會自動響應 `tiptapStructure` 變化

### 4. 性能考慮

- **問題**：多個 Tiptap 實例可能影響性能
- **解決**：
- 使用 `v-show` 而非 `v-if` 保持實例
- 或者只渲染可見的頁面（虛擬滾動）

## 修改文件清單

1. [`frontend/src/views/ResourceEditor.vue`](frontend/src/views/ResourceEditor.vue)

- 新增 `handoutPages` computed 屬性
- 新增 `estimateNodeHeight` 函數
- 修改講義模式的模板結構
- 添加編輯/預覽模式切換（可選）

2. [`frontend/src/components/BlockEditor/BlockEditor.vue`](frontend/src/components/BlockEditor/BlockEditor.vue)

- 新增 `readonly` prop
- 調整 `editable` 配置
- 移除頁碼覆蓋層（改由父組件顯示）

3. [`frontend/src/components/BlockEditor/components/PageBreakBlockComponent.vue`](frontend/src/components/BlockEditor/components/PageBreakBlockComponent.vue)

- 在多紙張模式下不需要顯示（內容已經分頁）
- 可以完全隱藏或顯示為簡單的分隔線

## 實現步驟

### 步驟 1：添加內容分割邏輯

- 在 ResourceEditor 中實現 `handoutPages` computed
- 實現 `estimateNodeHeight` 函數
- 處理 pageBreak 節點作為強制分頁點

### 步驟 2：修改模板結構

- 為講義模式創建多個紙張容器
- 每個容器固定高度，包含獨立的 BlockEditor
- 添加頁碼顯示

### 步驟 3：處理編輯體驗

- 決定編輯模式：單一編輯器 vs 多紙張編輯
- 實現模式切換（如果需要）
- 確保編輯變更正確反映到多紙張視圖

### 步驟 4：優化和測試

- 調整節點高度估算值
- 測試各種內容類型的分頁
- 確保列印正確

## 注意事項

1. **節點不分割原則**：當節點高度超過頁面剩餘空間時，整個節點移到下一頁