#!/bin/bash
# Git pre-push hook - åœ¨æ¨é€å‰é‹è¡Œæ¸¬è©¦
# å®‰è£æ–¹å¼: ln -s ../../scripts/pre-push .git/hooks/pre-push

set -e

echo "ğŸ” é‹è¡Œ pre-push æª¢æŸ¥..."

# ç²å–æ¨é€çš„åˆ†æ”¯åç¨±
while read local_ref local_sha remote_ref remote_sha
do
    if [ -n "$remote_ref" ]; then
        branch=$(echo "$remote_ref" | sed 's|refs/heads/||')
        break
    fi
done

# å¦‚æœæ˜¯ main æˆ– develop åˆ†æ”¯ï¼Œå¼·åˆ¶é‹è¡Œæ¸¬è©¦
if [ "$branch" = "main" ] || [ "$branch" = "develop" ]; then
    echo "âš ï¸  æ¨é€è‡³ $branch åˆ†æ”¯ï¼Œå¿…é ˆé‹è¡Œæ¸¬è©¦..."
    
    # æª¢æŸ¥æ˜¯å¦åœ¨ backend ç›®éŒ„
    if [ ! -d "backend" ]; then
        echo "âŒ éŒ¯èª¤ï¼šè«‹åœ¨é …ç›®æ ¹ç›®éŒ„é‹è¡Œæ­¤ hook"
        exit 1
    fi
    
    # é‹è¡Œå¾Œç«¯æ¸¬è©¦
    echo "ğŸ§ª é‹è¡Œå¾Œç«¯æ¸¬è©¦..."
    cd backend
    
    # æª¢æŸ¥æ˜¯å¦æœ‰è™›æ“¬ç’°å¢ƒ
    if [ -d "venv" ] || [ -n "$VIRTUAL_ENV" ]; then
        if [ -d "venv" ]; then
            source venv/bin/activate
        fi
    fi
    
    # é‹è¡Œæ¸¬è©¦
    python manage.py test --verbosity=1
    
    if [ $? -ne 0 ]; then
        echo ""
        echo "âŒ æ¸¬è©¦å¤±æ•—ï¼è«‹ä¿®å¾©æ‰€æœ‰æ¸¬è©¦éŒ¯èª¤å¾Œå†æ¨é€ã€‚"
        echo "   é‹è¡Œ 'python manage.py test' æŸ¥çœ‹è©³ç´°éŒ¯èª¤ä¿¡æ¯ã€‚"
        exit 1
    fi
    
    cd ..
    echo "âœ… æ‰€æœ‰æ¸¬è©¦å·²é€šéï¼"
else
    echo "â„¹ï¸  æ¨é€è‡³ $branch åˆ†æ”¯ï¼Œè·³éæœ¬åœ°æ¸¬è©¦ï¼ˆCI/CD æœƒé‹è¡Œæ¸¬è©¦ï¼‰"
fi

exit 0
